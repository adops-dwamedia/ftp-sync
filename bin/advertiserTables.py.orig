#!/usr/bin/python
# -*- coding: utf-8 -*-

import MySQLdb as mdb
import sys
import os
import re
import datetime
from warnings import filterwarnings

filterwarnings('ignore', category = mdb.Warning)

host = '184.105.184.30'
user = 'tomb'
pw = 'DW4mediatb'
db = 'SF_Match'

<<<<<<< HEAD
log_path="/usr/local/ftp_sync/logs"

=======
>>>>>>> a904d90b2e1c9ce80562f669147c5dcc3aa06774
# get db handle:
try:
	con = mdb.connect(host, user, pw, db)
	cur = con.cursor()

	con.set_character_set('utf8')
	cur.execute('SET NAMES utf8;') 
	cur.execute('SET CHARACTER SET utf8;')
	cur.execute('SET character_set_connection=utf8;')

        
except mdb.Error, e:

	print "Error %d: %s" % (e.args[0], e.args[1])
	sys.exit(1)

cur.execute("SELECT AdvertiserName, AdvertiserID FROM Advertisers")
advert = cur.fetchall()
for a in advert:
<<<<<<< HEAD
	tableName = "DWA_SF_Cookie."+a[0].replace(" ", "_")+"_Std"
=======
	tableName = a[0].replace(" ", "_")+"_Standard"
>>>>>>> a904d90b2e1c9ce80562f669147c5dcc3aa06774
	# check if table exists:
	cur.execute("SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE '%s'"%tableName);
	res = cur.fetchall()

<<<<<<< HEAD
	if True:#len(res) == 0:
		print "Creating table %s"%tableName
		stmt0 = "DROP TABLE IF EXISTS %s"%tableName
		stmt1 = "CREATE TABLE IF NOT EXISTS %s"%tableName + " AS SELECT UserID, EventID, EventTypeID, STR_TO_DATE(EventDate, '%m/%d/%Y %h:%i:%s %p') AS EventDate, CampaignID, SiteID, PlacementID, IP, AdvertiserID FROM DWA_SF_Cookie.MM_Standard WHERE 1=0"
		stmt2 = "ALTER TABLE %s ADD PRIMARY KEY(EventID)"%tableName
		stmt3 = "ALTER TABLE %s ADD INDEX (UserID)"%tableName
		stmt4 = "ALTER TABLE %s ADD INDEX (EventDate)"%tableName
		cur.execute(stmt0)
=======
	if len(res) == 0:
		print "asdf"
#		stmt0 = "DROP TABLE IF EXISTS MM_Standard_P.%s"%tableName
		stmt1 = "CREATE TABLE IF NOT EXISTS MM_Standard_P.%s AS SELECT * FROM DWA_SF_Cookie.MM_Standard_P WHERE 1=0"%tableName
		stmt2 = "ALTER TABLE MM_Standard_P.%s ADD PRIMARY KEY(EventID)"%tableName
		stmt3 = "ALTER TABLE MM_Standard_P.%s ADD INDEX (UserID)"%tableName
		stmt4 = "ALTER TABLE MM_Standard_P.%s ADD INDEX (EventDate)"%tableName
	#	cur.execute(stmt0)
>>>>>>> a904d90b2e1c9ce80562f669147c5dcc3aa06774
		cur.execute(stmt1)
		cur.execute(stmt2)
		cur.execute(stmt3)
		cur.execute(stmt4)
	
<<<<<<< HEAD
	stmt5 = "INSERT IGNORE INTO %s"%tableName + " SELECT UserID, EventID, EventTypeID, STR_TO_DATE(EventDate, '%m/%d/%Y %h:%i:%s %p'), CampaignID, SiteID, PlacementID, IP, AdvertiserID FROM DWA_SF_Cookie.MM_Standard WHERE AdvertiserID ="+" %s"%a[1]
	print stmt5
	os.system("echo %s updated at %s>> %s/adTables.log"%(tableName, datetime.datetime.now(), log_path))
=======
	stmt5 = "INSERT IGNORE INTO MM_Standard_P.%s SELECT UserID, EventID, EventTypeID, EventDate, CampaignID, SiteID, PlacementID, IP, AdvertiserID FROM DWA_SF_Cookie.MM_Standard_P WHERE AdvertiserID = %s"%(tableName, a[1])


>>>>>>> a904d90b2e1c9ce80562f669147c5dcc3aa06774
	cur.execute(stmt5)



if con:
	con.close()


